<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" th:href="@{/css/jobposting.css}">
   
    <style>
        .draft-options {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .draft-card {
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .draft-card:hover {
            border-color: #007bff;
            background-color: #f8f9ff;
        }
        .draft-card.selected {
            border-color: #007bff;
            background-color: #e7f3ff;
        }
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div th:replace="ownerheader :: owner-header"></div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <!-- Toast Notifications -->
    <div class="toast-container position-fixed top-0 end-0 p-3">
        <div id="successToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <i class="bi bi-check-circle text-success me-2"></i>
                <strong class="me-auto">Success</strong>
                <small>Just now</small>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="successToastBody">
                Job posted successfully!
            </div>
        </div>
        <div id="errorToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <i class="bi bi-exclamation-triangle text-danger me-2"></i>
                <strong class="me-auto">Error</strong>
                <small>Just now</small>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body">
                Failed to post job. Please try again.
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container my-4">
        <div class="job-posting-container">
            <!-- Header -->
            <div class="posting-header">
                <h1 class="h3 mb-2">Post a New Job</h1>
                <p class="mb-0">Fill in the details below to create your job posting</p>
            </div>

            <!-- Draft Selection (Show only if draft exists) -->
            <div class="draft-options" id="draftOptions" style="display: none;">
                <h5 class="mb-3"><i class="bi bi-file-earmark me-2"></i>Continue with saved draft?</h5>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <div class="draft-card" id="newJobCard" onclick="selectOption('new')">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-plus-circle fs-4 text-primary me-3"></i>
                                <div>
                                    <h6 class="mb-1">Start New Job Post</h6>
                                    <p class="text-muted mb-0">Create a fresh job posting from scratch</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="draft-card" id="draftCard" onclick="selectOption('draft')">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-file-earmark fs-4 text-warning me-3"></i>
                                <div>
                                    <h6 class="mb-1">Continue with Draft</h6>
                                    <p class="text-muted mb-0" id="draftInfo">Use your saved draft</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="text-center mt-3">
                    <button class="btn btn-primary" id="confirmSelection" disabled>Continue</button>
                </div>
            </div>

            <!-- Progress Indicator -->
            <div class="progress-container" id="progressContainer">
                <div class="step-indicator">
                    <div class="step active" id="step1">
                        <div class="step-circle">1</div>
                        <div class="step-label">Job Details</div>
                    </div>
                    <div class="step" id="step2">
                        <div class="step-circle">2</div>
                        <div class="step-label">Requirements</div>
                    </div>
                    <div class="step" id="step3">
                        <div class="step-circle">3</div>
                        <div class="step-label">Compensation</div>
                    </div>
                    <div class="step" id="step4">
                        <div class="step-circle">4</div>
                        <div class="step-label">Application</div>
                    </div>
                    <div class="step" id="step5">
                        <div class="step-circle">5</div>
                        <div class="step-label">Preview</div>
                    </div>
                </div>
                <div class="progress">
                    <div class="progress-bar" id="progressBar" style="width: 20%"></div>
                </div>
            </div>

            <!-- Job Posting Form -->
            <form th:action="@{/owner/job/post}" method="post" id="jobPostingForm">
                <!-- Hidden field to track if using draft -->
                <input type="hidden" id="useDraft" name="useDraft" value="false">
                
                <!-- Job Details -->
                <div class="form-section active" id="section1">
                    <h3 class="section-title"><i class="bi bi-briefcase"></i> Job Details</h3>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="jobTitle" class="form-label">Job Title *</label>
                            <input type="text" class="form-control" id="jobTitle" name="jobTitle" placeholder="e.g. Senior Web Developer" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="jobType" class="form-label">Job Type *</label>
                            <select class="form-select" id="jobType" name="jobType" required>
                                <option value="" selected disabled>Select job type</option>
                                <option value="full-time">Full-time</option>
                                <option value="part-time">Part-time</option>
                                <option value="contract">Contract</option>
                                <option value="freelance">Freelance</option>
                                <option value="internship">Internship</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Category Selection -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="categoryId" class="form-label">Job Category *</label>
                            <select class="form-select" id="categoryId" name="categoryId" required>
                                <option value="" selected disabled>Select a category</option>
                                <option th:each="category : ${categories}" 
                                        th:value="${category.id}" 
                                        th:text="${category.catName}">
                                </option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="department" class="form-label">Department</label>
                            <input type="text" class="form-control" id="department" name="department" placeholder="e.g. Engineering">
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="location" class="form-label">Location *</label>
                            <input type="text" class="form-control" id="location" name="location" placeholder="e.g. New York, NY" required>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="jobDescription" class="form-label">Job Description *</label>
                        <textarea class="form-control" id="jobDescription" name="jobDescription" rows="5" placeholder="Describe the role, responsibilities, and requirements..." required></textarea>
                    </div>
                    
                    <div class="form-navigation">
                        <div class="navigation-left">
                            <button type="button" class="btn btn-outline-warning" id="saveDraft1">
                                <i class="bi bi-file-earmark me-1"></i> Save as Draft
                            </button>
                        </div>
                        <div class="navigation-right">
                            <button type="button" class="btn btn-primary" id="next1">Next <i class="bi bi-arrow-right ms-1"></i></button>
                        </div>
                    </div>
                </div>

                <!-- Company Details -->
                <div class="form-section" id="section2">
                    <h3 class="section-title"><i class="bi bi-building"></i> Company Details</h3>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="companyName" class="form-label">Company Name *</label>
                            <input type="text" class="form-control" id="companyName" th:value="${owner.companyName}" readonly>
                            <input type="hidden" name="companyName" th:value="${owner.companyName}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="companyWebsite" class="form-label">Website</label>
                            <input type="url" class="form-control" id="companyWebsite" name="companyWebsite" placeholder="https://example.com">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="companyDescription" class="form-label">Company Description</label>
                        <textarea class="form-control" id="companyDescription" th:text="${owner.description}" readonly></textarea>
                        <input type="hidden" name="companyDescription" th:value="${owner.description}">
                    </div>
                    
                    <h3 class="section-title mt-4"><i class="bi bi-list-check"></i> Requirements & Skills</h3>
                    
                    <div class="mb-3">
                        <label class="form-label">Required Skills *</label>
                        <div class="mb-2">
                            <input type="text" class="form-control" id="skillInput" placeholder="Add a skill and press Enter">
                        </div>
                        <div id="skillsContainer" class="d-flex flex-wrap gap-2 mb-2">
                            <!-- Skills will be added here dynamically -->
                        </div>
                        <input type="hidden" id="requiredSkills" name="requiredSkills" required>
                        <div class="form-text">Add skills by typing and pressing Enter. Click the × button to remove a skill.</div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="experienceLevel" class="form-label">Experience Level</label>
                            <select class="form-select" id="experienceLevel" name="experienceLevel">
                                <option value="" selected>Select experience level</option>
                                <option value="intern">Intern</option>
                                <option value="entry">Entry Level</option>
                                <option value="mid">Mid Level</option>
                                <option value="senior">Senior Level</option>
                                <option value="lead">Lead</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="educationLevel" class="form-label">Education Level</label>
                            <select class="form-select" id="educationLevel" name="educationLevel">
                                <option value="" selected>Select education level</option>
                                <option value="high-school">High School</option>
                                <option value="associate">Associate Degree</option>
                                <option value="bachelor">Bachelor's Degree</option>
                                <option value="master">Master's Degree</option>
                                <option value="phd">PhD</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-navigation">
                        <div class="navigation-left">
                            <button type="button" class="btn btn-outline-warning" id="saveDraft2">
                                <i class="bi bi-file-earmark me-1"></i> Save as Draft
                            </button>
                        </div>
                        <div class="navigation-right">
                            <button type="button" class="btn btn-outline-secondary" id="prev2">
                                <i class="bi bi-arrow-left me-1"></i> Previous
                            </button>
                            <button type="button" class="btn btn-primary" id="next2">Next <i class="bi bi-arrow-right ms-1"></i></button>
                        </div>
                    </div>
                </div>

                <!-- Compensation & Benefits -->
                <div class="form-section" id="section3">
                    <h3 class="section-title"><i class="bi bi-currency-dollar"></i> Compensation & Benefits</h3>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="salaryMin" class="form-label">Salary Range (Min)</label>
                            <div class="input-group">
                                <span class="input-group-text">MMK</span>
                                <input type="number" class="form-control" id="salaryMin" name="salaryMin" placeholder="e.g. 50000" min="0">
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="salaryMax" class="form-label">Salary Range (Max)</label>
                            <div class="input-group">
                                <span class="input-group-text">MMK</span>
                                <input type="number" class="form-control" id="salaryMax" name="salaryMax" placeholder="e.g. 80000" min="0">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Benefits</label>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check mb-2">
                                    <input class="form-check-input benefit-checkbox" type="checkbox" id="healthInsurance" value="Health Insurance">
                                    <label class="form-check-label" for="healthInsurance">Health Insurance</label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input benefit-checkbox" type="checkbox" id="dentalInsurance" value="Dental Insurance">
                                    <label class="form-check-label" for="dentalInsurance">Dental Insurance</label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input benefit-checkbox" type="checkbox" id="retirementPlan" value="Retirement Plan">
                                    <label class="form-check-label" for="retirementPlan">Retirement Plan</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check mb-2">
                                    <input class="form-check-input benefit-checkbox" type="checkbox" id="paidTimeOff" value="Paid Time Off">
                                    <label class="form-check-label" for="paidTimeOff">Paid Time Off</label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input benefit-checkbox" type="checkbox" id="remoteWork" value="Remote Work Options">
                                    <label class="form-check-label" for="remoteWork">Remote Work Options</label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input benefit-checkbox" type="checkbox" id="flexibleHours" value="Flexible Hours">
                                    <label class="form-check-label" for="flexibleHours">Flexible Hours</label>
                                </div>
                            </div>
                        </div>
                        <input type="hidden" id="benefits" name="benefits">
                    </div>
                    
                    <div class="form-navigation">
                        <div class="navigation-left">
                            <button type="button" class="btn btn-outline-warning" id="saveDraft3">
                                <i class="bi bi-file-earmark me-1"></i> Save as Draft
                            </button>
                        </div>
                        <div class="navigation-right">
                            <button type="button" class="btn btn-outline-secondary" id="prev3">
                                <i class="bi bi-arrow-left me-1"></i> Previous
                            </button>
                            <button type="button" class="btn btn-primary" id="next3">Next <i class="bi bi-arrow-right ms-1"></i></button>
                        </div>
                    </div>
                </div>

                <!-- Application Process -->
                <div class="form-section" id="section4">
                    <h3 class="section-title"><i class="bi bi-send"></i> Application Process</h3>
                    
                    <div class="mb-3">
                        <label for="applicationEmail" class="form-label">Application Email *</label>
                        <input type="email" class="form-control" id="applicationEmail" th:value="${owner.gmail}" readonly>
                        <input type="hidden" name="applicationEmail" th:value="${owner.gmail}">
                    </div>
                    
                    <div class="mb-3">
                        <label for="applicationDeadline" class="form-label">Application Deadline</label>
                        <input type="date" class="form-control" id="applicationDeadline" name="applicationDeadline">
                    </div>
                    
                    <div class="mb-3">
                        <label for="applicationInstructions" class="form-label">Application Instructions</label>
                        <textarea class="form-control" id="applicationInstructions" name="applicationInstructions" rows="3" placeholder="Any specific instructions for applicants..."></textarea>
                    </div>
                    
                    <div class="form-navigation">
                        <div class="navigation-left">
                            <button type="button" class="btn btn-outline-warning" id="saveDraft4">
                                <i class="bi bi-file-earmark me-1"></i> Save as Draft
                            </button>
                        </div>
                        <div class="navigation-right">
                            <button type="button" class="btn btn-outline-secondary" id="prev4">
                                <i class="bi bi-arrow-left me-1"></i> Previous
                            </button>
                            <button type="button" class="btn btn-primary" id="next4">Next <i class="bi bi-arrow-right ms-1"></i></button>
                        </div>
                    </div>
                </div>

                <!-- Preview & Submit -->
                <div class="form-section" id="section5">
                    <h3 class="section-title"><i class="bi bi-eye"></i> Preview</h3>
                    
                    <div class="preview-card">
                        <div class="preview-title" id="previewJobTitle">Job Title</div>
                        <div class="preview-company" id="previewCompany" th:text="${owner.companyName}">Company Name</div>
                        
                        <div class="preview-details">
                            <div class="preview-detail">
                                <i class="bi bi-geo-alt"></i> <span id="previewLocation">Location</span>
                            </div>
                            <div class="preview-detail">
                                <i class="bi bi-clock"></i> <span id="previewJobType">Job Type</span>
                            </div>
                            <div class="preview-detail">
                                <i class="bi bi-tags"></i> <span id="previewCategory">Category</span>
                            </div>
                            <div class="preview-detail">
                                <i class="bi bi-cash"></i> <span id="previewSalary">Salary</span>
                            </div>
                            <div class="preview-detail">
                                <i class="bi bi-person"></i> <span id="previewExperience">Experience Level</span>
                            </div>
                        </div>
                        
                        <div class="preview-description" id="previewDescription">
                            Job description will appear here...
                        </div>
                        
                        <div class="mt-3" id="previewSkills">
                            <!-- Skills will appear here -->
                        </div>
                        
                        <div class="mt-3" id="previewBenefits">
                            <!-- Benefits will appear here -->
                        </div>
                    </div>
                    
                    <div class="form-navigation">
                        <div class="navigation-left">
                            <button type="button" class="btn btn-outline-warning" id="saveDraft5">
                                <i class="bi bi-file-earmark me-1"></i> Save as Draft
                            </button>
                        </div>
                        <div class="navigation-right">
                            <button type="button" class="btn btn-outline-secondary" id="prev5">
                                <i class="bi bi-arrow-left me-1"></i> Previous
                            </button>
                            <button type="button" class="btn btn-outline-primary me-2" id="previewBtn">
                                <i class="bi bi-arrow-clockwise me-1"></i> Refresh Preview
                            </button>
                            <button type="submit" class="btn btn-success">
                                <i class="bi bi-send me-1"></i> Post Job
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Multi-step form navigation
            let currentStep = 1;
            const totalSteps = 5;
            let selectedOption = '';
            let hasShownDraftOptions = false;

            // Skills functionality
            const skillInput = document.getElementById('skillInput');
            const skillsContainer = document.getElementById('skillsContainer');
            const previewSkills = document.getElementById('previewSkills');
            const requiredSkillsInput = document.getElementById('requiredSkills');
            
            // Benefits functionality
            const benefitCheckboxes = document.querySelectorAll('.benefit-checkbox');
            const benefitsInput = document.getElementById('benefits');

            // Check for existing draft and show options
            function checkForDraft() {
                const savedDraft = localStorage.getItem('jobDraft');
                if (savedDraft && !hasShownDraftOptions) {
                    try {
                        const draft = JSON.parse(savedDraft);
                        if (draft.jobTitle || draft.jobType || draft.location) {
                            showDraftOptions(draft);
                        }
                    } catch (error) {
                        console.error('Error parsing draft:', error);
                    }
                }
            }

            function showDraftOptions(draft) {
                const draftOptions = document.getElementById('draftOptions');
                const progressContainer = document.getElementById('progressContainer');
                const formSections = document.querySelectorAll('.form-section');
                
                // Hide form and progress initially
                progressContainer.style.display = 'none';
                formSections.forEach(section => section.style.display = 'none');
                
                // Update draft info
                const draftInfo = document.getElementById('draftInfo');
                const draftTitle = draft.jobTitle || 'Untitled Draft';
                const draftStep = draft.currentStep || 1;
                draftInfo.textContent = `${draftTitle} (Step ${draftStep}/5)`;
                
                // Show draft options
                draftOptions.style.display = 'block';
                hasShownDraftOptions = true;
            }

            function selectOption(option) {
                selectedOption = option;
                
                // Update UI
                document.getElementById('newJobCard').classList.toggle('selected', option === 'new');
                document.getElementById('draftCard').classList.toggle('selected', option === 'draft');
                document.getElementById('confirmSelection').disabled = false;
            }

            function confirmSelection() {
                const draftOptions = document.getElementById('draftOptions');
                const progressContainer = document.getElementById('progressContainer');
                const formSections = document.querySelectorAll('.form-section');
                
                if (selectedOption === 'new') {
                    // Clear draft and start fresh
                    localStorage.removeItem('jobDraft');
                    document.getElementById('useDraft').value = 'false';
                    
                    // Reset form
                    document.getElementById('jobPostingForm').reset();
                    skillsContainer.innerHTML = '';
                    updateRequiredSkills();
                    updatePreview();
                    
                    // Show form
                    draftOptions.style.display = 'none';
                    progressContainer.style.display = 'block';
                    formSections.forEach((section, index) => {
                        section.style.display = index === 0 ? 'block' : 'none';
                    });
                    
                } else if (selectedOption === 'draft') {
                    // Load draft
                    document.getElementById('useDraft').value = 'true';
                    loadDraft();
                    
                    // Show form
                    draftOptions.style.display = 'none';
                    progressContainer.style.display = 'block';
                    formSections.forEach(section => section.style.display = 'block');
                    
                    // Show success message
                    showToast('Draft loaded successfully!', 'success');
                }
            }

            // Enhanced save draft function
            function saveDraft() {
                const formData = {
                    jobTitle: document.getElementById('jobTitle').value,
                    jobType: document.getElementById('jobType').value,
                    categoryId: document.getElementById('categoryId').value,
                    department: document.getElementById('department').value,
                    location: document.getElementById('location').value,
                    jobDescription: document.getElementById('jobDescription').value,
                    companyWebsite: document.getElementById('companyWebsite').value,
                    experienceLevel: document.getElementById('experienceLevel').value,
                    educationLevel: document.getElementById('educationLevel').value,
                    salaryMin: document.getElementById('salaryMin').value,
                    salaryMax: document.getElementById('salaryMax').value,
                    applicationDeadline: document.getElementById('applicationDeadline').value,
                    applicationInstructions: document.getElementById('applicationInstructions').value,
                    requiredSkills: requiredSkillsInput.value,
                    benefits: benefitsInput.value,
                    currentStep: currentStep,
                    lastSaved: new Date().toISOString()
                };
                
                localStorage.setItem('jobDraft', JSON.stringify(formData));
                showToast('Draft saved successfully!', 'success');
            }

            // Enhanced load draft function
            function loadDraft() {
                const savedDraft = localStorage.getItem('jobDraft');
                if (savedDraft) {
                    try {
                        const draft = JSON.parse(savedDraft);
                        
                        // Load form data
                        document.getElementById('jobTitle').value = draft.jobTitle || '';
                        document.getElementById('jobType').value = draft.jobType || '';
                        document.getElementById('categoryId').value = draft.categoryId || '';
                        document.getElementById('department').value = draft.department || '';
                        document.getElementById('location').value = draft.location || '';
                        document.getElementById('jobDescription').value = draft.jobDescription || '';
                        document.getElementById('companyWebsite').value = draft.companyWebsite || '';
                        document.getElementById('experienceLevel').value = draft.experienceLevel || '';
                        document.getElementById('educationLevel').value = draft.educationLevel || '';
                        document.getElementById('salaryMin').value = draft.salaryMin || '';
                        document.getElementById('salaryMax').value = draft.salaryMax || '';
                        document.getElementById('applicationDeadline').value = draft.applicationDeadline || '';
                        document.getElementById('applicationInstructions').value = draft.applicationInstructions || '';
                        
                        // Load skills
                        skillsContainer.innerHTML = '';
                        if (draft.requiredSkills) {
                            draft.requiredSkills.split(',').forEach(skill => {
                                if (skill.trim()) {
                                    addSkill(skill.trim());
                                }
                            });
                        }
                        
                        // Load benefits
                        if (draft.benefits) {
                            const benefits = draft.benefits.split(',');
                            benefitCheckboxes.forEach(checkbox => {
                                checkbox.checked = benefits.includes(checkbox.value);
                            });
                            updateBenefits();
                        }
                        
                        // Navigate to saved step
                        if (draft.currentStep && draft.currentStep > 1) {
                            currentStep = draft.currentStep;
                            showStep(currentStep);
                        }
                        
                        updatePreview();
                        
                    } catch (error) {
                        console.error('Error loading draft:', error);
                        showToast('Error loading draft. Starting fresh.', 'error');
                    }
                }
            }

            // Toast notification function
            function showToast(message, type) {
                const toast = new bootstrap.Toast(document.getElementById('successToast'));
                const toastBody = document.getElementById('successToastBody');
                
                if (type === 'success') {
                    toastBody.textContent = message;
                    toast.show();
                }
            }

            // Navigation functions
            function showStep(step) {
                // Hide all sections
                document.querySelectorAll('.form-section').forEach(section => {
                    section.classList.remove('active');
                });
                
                // Show current section
                document.getElementById(`section${step}`).classList.add('active');
                
                // Update progress indicator
                updateProgressIndicator(step);
                
                // Update preview if we're on the preview step
                if (step === 5) {
                    updatePreview();
                }
            }
            
            function updateProgressIndicator(step) {
                // Update step indicators
                document.querySelectorAll('.step').forEach((stepEl, index) => {
                    if (index + 1 < step) {
                        stepEl.classList.remove('active');
                        stepEl.classList.add('completed');
                    } else if (index + 1 === step) {
                        stepEl.classList.add('active');
                        stepEl.classList.remove('completed');
                    } else {
                        stepEl.classList.remove('active', 'completed');
                    }
                });
                
                // Update progress bar
                const progress = ((step - 1) / (totalSteps - 1)) * 100;
                document.getElementById('progressBar').style.width = `${progress}%`;
            }
            
            // Step navigation functionality - Click on any step to jump to it
            document.querySelectorAll('.step').forEach((step, index) => {
                step.addEventListener('click', function() {
                    const stepNumber = index + 1;
                    
                    // Don't allow jumping to future steps without validation
                    if (stepNumber > currentStep && !validateAllPreviousSteps(stepNumber)) {
                        return;
                    }
                    
                    currentStep = stepNumber;
                    showStep(currentStep);
                });
            });
            
            // Validate all steps up to the target step
            function validateAllPreviousSteps(targetStep) {
                for (let i = 1; i < targetStep; i++) {
                    if (!validateStep(i)) {
                        // Show which step has validation issues
                        alert(`Please complete step ${i} before jumping to step ${targetStep}`);
                        return false;
                    }
                }
                return true;
            }
            
            // Navigation event listeners
            document.getElementById('next1').addEventListener('click', function() {
                if (validateStep(1)) {
                    currentStep = 2;
                    showStep(currentStep);
                }
            });
            
            document.getElementById('next2').addEventListener('click', function() {
                // Validate skills
                const skills = requiredSkillsInput.value.trim();
                if (!skills) {
                    alert('Please add at least one required skill.');
                    skillInput.focus();
                    return;
                }
                
                currentStep = 3;
                showStep(currentStep);
            });
            
            document.getElementById('next3').addEventListener('click', function() {
                currentStep = 4;
                showStep(currentStep);
            });
            
            document.getElementById('next4').addEventListener('click', function() {
                currentStep = 5;
                showStep(currentStep);
            });
            
            // Previous buttons
            document.getElementById('prev2').addEventListener('click', function() {
                currentStep = 1;
                showStep(currentStep);
            });
            
            document.getElementById('prev3').addEventListener('click', function() {
                currentStep = 2;
                showStep(currentStep);
            });
            
            document.getElementById('prev4').addEventListener('click', function() {
                currentStep = 3;
                showStep(currentStep);
            });
            
            document.getElementById('prev5').addEventListener('click', function() {
                currentStep = 4;
                showStep(currentStep);
            });
            
            // Step validation
            function validateStep(step) {
                if (step === 1) {
                    const jobTitle = document.getElementById('jobTitle').value.trim();
                    const jobType = document.getElementById('jobType').value;
                    const location = document.getElementById('location').value.trim();
                    const jobDescription = document.getElementById('jobDescription').value.trim();
                    const categoryId = document.getElementById('categoryId').value;
                    
                    if (!jobTitle) {
                        alert('Please enter a job title.');
                        document.getElementById('jobTitle').focus();
                        return false;
                    }
                    
                    if (!jobType) {
                        alert('Please select a job type.');
                        document.getElementById('jobType').focus();
                        return false;
                    }
                    
                    if (!location) {
                        alert('Please enter a location.');
                        document.getElementById('location').focus();
                        return false;
                    }
                    
                    if (!jobDescription) {
                        alert('Please enter a job description.');
                        document.getElementById('jobDescription').focus();
                        return false;
                    }
                    
                    if (!categoryId) {
                        alert('Please select a job category.');
                        document.getElementById('categoryId').focus();
                        return false;
                    }
                }
                
                return true;
            }
            
            // Skills functionality
            skillInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const skill = skillInput.value.trim();
                    if (skill) {
                        addSkill(skill);
                        skillInput.value = '';
                    }
                }
            });
            
            function addSkill(skill) {
                // Create skill tag
                const skillElement = document.createElement('div');
                skillElement.className = 'skill-tag';
                skillElement.innerHTML = `
                    ${skill}
                    <button type="button" class="btn-close" onclick="removeSkill(this)"></button>
                `;
                skillsContainer.appendChild(skillElement);
                
                // Update hidden input and preview
                updateRequiredSkills();
                updatePreviewSkills();
            }
            
            function removeSkill(button) {
                button.parentElement.remove();
                updateRequiredSkills();
                updatePreviewSkills();
            }
            
            function updateRequiredSkills() {
                const skills = Array.from(skillsContainer.querySelectorAll('.skill-tag'))
                    .map(tag => tag.textContent.trim().replace('×', ''));
                requiredSkillsInput.value = skills.join(',');
                
                // Update validation state
                if (skills.length > 0) {
                    requiredSkillsInput.setCustomValidity('');
                } else {
                    requiredSkillsInput.setCustomValidity('Please add at least one skill');
                }
            }
            
            function updatePreviewSkills() {
                const skills = Array.from(skillsContainer.querySelectorAll('.skill-tag'))
                    .map(tag => tag.textContent.trim().replace('×', ''));
                
                previewSkills.innerHTML = '';
                if (skills.length > 0) {
                    const skillsTitle = document.createElement('div');
                    skillsTitle.className = 'fw-bold mb-2';
                    skillsTitle.textContent = 'Required Skills:';
                    previewSkills.appendChild(skillsTitle);
                    
                    skills.forEach(skill => {
                        const skillElement = document.createElement('span');
                        skillElement.className = 'tag';
                        skillElement.textContent = skill;
                        previewSkills.appendChild(skillElement);
                    });
                }
            }
            
            // Benefits functionality
            benefitCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', updateBenefits);
            });
            
            function updateBenefits() {
                const selectedBenefits = Array.from(benefitCheckboxes)
                    .filter(checkbox => checkbox.checked)
                    .map(checkbox => checkbox.value);
                benefitsInput.value = selectedBenefits.join(',');
                updatePreviewBenefits();
            }
            
            function updatePreviewBenefits() {
                const selectedBenefits = Array.from(benefitCheckboxes)
                    .filter(checkbox => checkbox.checked)
                    .map(checkbox => checkbox.value);
                
                const previewBenefits = document.getElementById('previewBenefits');
                previewBenefits.innerHTML = '';
                
                if (selectedBenefits.length > 0) {
                    const benefitsTitle = document.createElement('div');
                    benefitsTitle.className = 'fw-bold mb-2';
                    benefitsTitle.textContent = 'Benefits:';
                    previewBenefits.appendChild(benefitsTitle);
                    
                    selectedBenefits.forEach(benefit => {
                        const benefitElement = document.createElement('span');
                        benefitElement.className = 'tag';
                        benefitElement.textContent = benefit;
                        previewBenefits.appendChild(benefitElement);
                    });
                }
            }
            
            // Preview functionality
            document.getElementById('previewBtn').addEventListener('click', updatePreview);
            
            function updatePreview() {
                // Job details
                document.getElementById('previewJobTitle').textContent = 
                    document.getElementById('jobTitle').value || 'Job Title';
                document.getElementById('previewLocation').textContent = 
                    document.getElementById('location').value || 'Location';
                
                const jobTypeSelect = document.getElementById('jobType');
                const jobTypeText = jobTypeSelect.options[jobTypeSelect.selectedIndex]?.text || 'Job Type';
                document.getElementById('previewJobType').textContent = jobTypeText;
                
                // Category
                const categorySelect = document.getElementById('categoryId');
                const categoryText = categorySelect.options[categorySelect.selectedIndex]?.text || 'Not specified';
                document.getElementById('previewCategory').textContent = categoryText;
                
                // Experience level
                const experienceSelect = document.getElementById('experienceLevel');
                const experienceText = experienceSelect.options[experienceSelect.selectedIndex]?.text || 'Not specified';
                document.getElementById('previewExperience').textContent = experienceText;
                
                // Salary
                const minSalary = document.getElementById('salaryMin').value;
                const maxSalary = document.getElementById('salaryMax').value;
                let salaryText = 'Salary not specified';
                if (minSalary && maxSalary) {
                    salaryText = `MMK ${parseInt(minSalary).toLocaleString()} - MMK ${parseInt(maxSalary).toLocaleString()}`;
                } else if (minSalary) {
                    salaryText = `From MMK ${parseInt(minSalary).toLocaleString()}`;
                } else if (maxSalary) {
                    salaryText = `Up to MMK ${parseInt(maxSalary).toLocaleString()}`;
                }
                document.getElementById('previewSalary').textContent = salaryText;
                
                // Description (truncate if too long)
                const fullDescription = document.getElementById('jobDescription').value;
                const previewDescription = fullDescription.length > 300 ? 
                    fullDescription.substring(0, 300) + '...' : fullDescription;
                document.getElementById('previewDescription').textContent = 
                    previewDescription || 'Job description will appear here...';
                
                // Skills and Benefits
                updatePreviewSkills();
                updatePreviewBenefits();
            }

            // Setup event listeners for draft functionality
            document.getElementById('confirmSelection').addEventListener('click', confirmSelection);
            
            // Enhanced save draft buttons setup
            function setupSaveDraftButtons() {
                for (let i = 1; i <= 5; i++) {
                    document.getElementById(`saveDraft${i}`).addEventListener('click', function() {
                        saveDraft();
                    });
                }
            }

            // Enhanced form submission
            document.getElementById('jobPostingForm').addEventListener('submit', function(e) {
                // Validate required skills
                const skills = requiredSkillsInput.value.trim();
                if (!skills) {
                    e.preventDefault();
                    alert('Please add at least one required skill.');
                    skillInput.focus();
                    return false;
                }
                
                // Validate other required fields
                const jobTitle = document.getElementById('jobTitle').value.trim();
                const jobType = document.getElementById('jobType').value;
                const location = document.getElementById('location').value.trim();
                const jobDescription = document.getElementById('jobDescription').value.trim();
                const categoryId = document.getElementById('categoryId').value;
                
                if (!jobTitle) {
                    e.preventDefault();
                    alert('Please enter a job title.');
                    document.getElementById('jobTitle').focus();
                    return false;
                }
                
                if (!jobType) {
                    e.preventDefault();
                    alert('Please select a job type.');
                    document.getElementById('jobType').focus();
                    return false;
                }
                
                if (!location) {
                    e.preventDefault();
                    alert('Please enter a location.');
                    document.getElementById('location').focus();
                    return false;
                }
                
                if (!jobDescription) {
                    e.preventDefault();
                    alert('Please enter a job description.');
                    document.getElementById('jobDescription').focus();
                    return false;
                }
                
                if (!categoryId) {
                    e.preventDefault();
                    alert('Please select a job category.');
                    document.getElementById('categoryId').focus();
                    return false;
                }
                
                // Validate salary range
                const minSalary = parseInt(document.getElementById('salaryMin').value) || 0;
                const maxSalary = parseInt(document.getElementById('salaryMax').value) || 0;
                if (minSalary > 0 && maxSalary > 0 && minSalary > maxSalary) {
                    e.preventDefault();
                    alert('Minimum salary cannot be greater than maximum salary.');
                    document.getElementById('salaryMin').focus();
                    return false;
                }
                
                // Clear draft after successful submission
                localStorage.removeItem('jobDraft');
                
                // Show loading overlay
                document.getElementById('loadingOverlay').style.display = 'flex';
                
                return true;
            });

            // Auto-update preview when form changes
            const formElements = document.querySelectorAll('#jobPostingForm input, #jobPostingForm select, #jobPostingForm textarea');
            formElements.forEach(element => {
                element.addEventListener('input', updatePreview);
                element.addEventListener('change', updatePreview);
            });

            // Initialize
            checkForDraft();
            setupSaveDraftButtons();
            updatePreview();
            
            // Make functions globally available
            window.selectOption = selectOption;
            window.removeSkill = removeSkill;
        });
    </script>
</body>
</html>